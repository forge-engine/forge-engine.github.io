<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Database & ORM API - Forge Kernel Documentation</title>
    <link rel="stylesheet" href="assets/css/forge-docs.css">
</head>
<body>
    <div class="docs-container">
        <aside class="sidebar">
            <nav>
                <ul class="sidebar-nav">
                    <li class="sidebar-nav-group">
                        <div class="sidebar-nav-group-title">Navigation</div>
                        <ul class="sidebar-nav" style="list-style: none; padding-left: 0;">
                            <li class="sidebar-nav-item">
                                <a href="index.html" class="sidebar-nav-link">Home</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="introduction.html" class="sidebar-nav-link">Introduction</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="getting-started.html" class="sidebar-nav-link">Getting Started</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="core-concepts.html" class="sidebar-nav-link">Core Concepts</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="modules.html" class="sidebar-nav-link">Capabilities</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-reference.html" class="sidebar-nav-link">API Reference</a>
                            </li>
                        </ul>
                    </li>
                    <li class="sidebar-nav-group">
                        <div class="sidebar-nav-group-title">API Sections</div>
                        <ul class="sidebar-nav" style="list-style: none; padding-left: 0;">
                            <li class="sidebar-nav-item">
                                <a href="api-core.html" class="sidebar-nav-link">Core Engine</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-http.html" class="sidebar-nav-link">HTTP Layer</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-database.html" class="sidebar-nav-link active">Database & ORM</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-di.html" class="sidebar-nav-link">DI Container</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-routing.html" class="sidebar-nav-link">Routing</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-modules.html" class="sidebar-nav-link">Module System</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-cli.html" class="sidebar-nav-link">CLI & Console</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-cache.html" class="sidebar-nav-link">Caching</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-validation.html" class="sidebar-nav-link">Validation</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-helpers.html" class="sidebar-nav-link">Helpers & Traits</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-events.html" class="sidebar-nav-link">Events</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="api-security.html" class="sidebar-nav-link">Security</a>
                            </li>
                        </ul>
                    </li>
                    <li class="sidebar-nav-group">
                        <div class="sidebar-nav-group-title">On This Page</div>
                        <ul class="sidebar-nav" style="list-style: none; padding-left: 0;">
                            <li class="sidebar-nav-item">
                                <a href="#database-connection" class="sidebar-nav-link">DatabaseConnection</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="#model" class="sidebar-nav-link">Model</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="#query-builder" class="sidebar-nav-link">QueryBuilder</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="#database-config" class="sidebar-nav-link">DatabaseConfig</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="#examples" class="sidebar-nav-link">Usage Examples</a>
                            </li>
                            <li class="sidebar-nav-item">
                                <a href="#best-practices" class="sidebar-nav-link">Some Suggestions</a>
                            </li>
                        </ul>
                    </li>
                </ul>
            </nav>
        </aside>

        <button class="mobile-menu-toggle" aria-label="Toggle menu">â˜°</button>
        <div class="mobile-overlay"></div>

        <main class="main-content">
            <article>
                <header class="docs-header">
                    <h1>Database & ORM API</h1>
                    <p>Database connectivity, ORM functionality, query building, and model management.</p>
                </header>

                <section>
                    <p>
                        <strong>Note:</strong> Database and ORM are <strong>not built into the kernel</strong>. They're capabilities you install when you need them. Install a database capability like <code>ForgeDatabaseSQL</code> or an ORM capability like <code>ForgeSqlOrm</code> to use these APIs.
                    </p>
                    <p>
                        These classes provide comprehensive database operations including connections, migrations, relationships, and query optimization for your Forge Kernel applications.
                    </p>
                </section>

                <section id="database-connection">
                    <h2>DatabaseConnection</h2>
                    <p>
                        Manages database connections and provides low-level database operations. The DatabaseConnection class handles connection pooling, query execution, and transaction management for multiple database types.
                    </p>

                    <h3>Constructor & Configuration</h3>
                    <div class="code-block">
                        <pre><code>&lt;?php
$connection = new DatabaseConnection([
    'driver' => 'mysql',
    'host' => 'localhost',
    'port' => 3306,
    'database' => 'myapp',
    'username' => 'root',
    'password' => 'password',
    'charset' => 'utf8mb4',
    'collation' => 'utf8mb4_unicode_ci',
    'prefix' => '',
    'strict' => true,
    'engine' => null
]);</code></pre>
                    </div>

                    <h3>Query Execution Methods</h3>
                    <h4>query(string $sql, array $bindings = []): array</h4>
                    <p>Execute a raw SQL query and return results.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$results = $connection->query('SELECT * FROM users WHERE active = ?', [true]);
$user = $connection->query('SELECT * FROM users WHERE id = ?', [$id])[0] ?? null;</code></pre>
                    </div>

                    <h4>execute(string $sql, array $bindings = []): int</h4>
                    <p>Execute a raw SQL statement and return affected rows.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$affected = $connection->execute('UPDATE users SET active = ? WHERE id = ?', [false, $id]);
$connection->execute('DELETE FROM sessions WHERE expired_at < ?', [now()]);</code></pre>
                    </div>

                    <h4>select(string $query, array $bindings = []): array</h4>
                    <p>Execute a SELECT query and return results.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$users = $connection->select('SELECT * FROM users WHERE created_at > ?', ['2023-01-01']);
$count = $connection->select('SELECT COUNT(*) as total FROM users')[0]['total'];</code></pre>
                    </div>

                    <h3>Transaction Methods</h3>
                    <h4>beginTransaction(): void</h4>
                    <p>Start a new database transaction.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$connection->beginTransaction();</code></pre>
                    </div>

                    <h4>commit(): void</h4>
                    <p>Commit the current transaction.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$connection->commit();</code></pre>
                    </div>

                    <h4>rollBack(): void</h4>
                    <p>Rollback the current transaction.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$connection->rollBack();</code></pre>
                    </div>

                    <h4>transaction(callable $callback): mixed</h4>
                    <p>Execute a callback within a transaction.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$result = $connection->transaction(function() use ($connection) {
    $userId = $connection->execute('INSERT INTO users (name, email) VALUES (?, ?)', ['John', 'john@example.com']);
    $connection->execute('INSERT INTO profiles (user_id, bio) VALUES (?, ?)', [$userId, 'Developer']);
    return $userId;
});</code></pre>
                    </div>
                </section>

                <section id="model">
                    <h2>Model</h2>
                    <p>
                        Base ORM model class providing database table mapping, relationships, and query building capabilities. Models represent database tables and provide an intuitive way to interact with your data.
                    </p>

                    <h3>Basic Model Definition</h3>
                    <p>Extend the base Model class and use attributes to define your model properties and relationships.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
use App\Modules\ForgeSqlOrm\ORM\Model;
use App\Modules\ForgeSqlOrm\ORM\Attributes\Table;
use App\Modules\ForgeSqlOrm\ORM\Attributes\Column;
use App\Modules\ForgeSqlOrm\ORM\Attributes\Hidden;
use App\Modules\ForgeSqlOrm\ORM\Attributes\ProtectedFields;
use App\Modules\ForgeSqlOrm\ORM\Values\Cast;
use App\Modules\ForgeSqlOrm\ORM\Values\Relate;
use App\Modules\ForgeSqlOrm\ORM\Values\RelationKind;

#[Table('users')]
#[ProtectedFields('password', 'remember_token')]
class User extends Model
{
    #[Column(primary: true, cast: Cast::INTEGER)]
    public int $id;
    
    #[Column(cast: Cast::STRING)]
    public string $name;
    
    #[Column(cast: Cast::STRING)]
    public string $email;
    
    #[Column(cast: Cast::STRING)]
    #[Hidden]
    public string $password;
    
    #[Column(cast: Cast::DATETIME, nullable: true)]
    public ?DateTimeImmutable $email_verified_at;
    
    #[Column(cast: Cast::BOOLEAN)]
    public bool $is_active;
    
    // Define relationships using #[Relate] attribute
    #[Relate(
        kind: RelationKind::HasMany,
        target: Post::class,
        foreignKey: 'user_id',
        localKey: 'id'
    )]
    public function posts()
    {
        return $this->relation('posts');
    }
    
    #[Relate(
        kind: RelationKind::HasOne,
        target: Profile::class,
        foreignKey: 'user_id',
        localKey: 'id'
    )]
    public function profile()
    {
        return $this->relation('profile');
    }
}</code></pre>
                    </div>

                    <h3>Query Methods</h3>
                    <h4>query(): ModelQuery</h4>
                    <p>Start a new query builder instance. All queries begin with <code>Model::query()</code>.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
// Get all records
$users = User::query()->get();

// Find by ID
$user = User::query()->id(1)->first();
$user = User::query()->id('550e8400-e29b-41d4-a716-446655440000')->first();</code></pre>
                    </div>

                    <h4>where(string $column, string $operator, mixed $value): ModelQuery</h4>
                    <p>Add a where clause to the query.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$users = User::query()->where('is_active', '=', true)->get();
$users = User::query()->where('age', '>', 18)->get();
$users = User::query()->where('email', 'like', '%@example.com')->get();</code></pre>
                    </div>

                    <h4>get(): array</h4>
                    <p>Execute the query and get all results as an array of Model instances.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$users = User::query()->where('is_active', '=', true)->get();
$users = User::query()->where('role', '=', 'admin')->get();</code></pre>
                    </div>

                    <h4>first(): ?Model</h4>
                    <p>Get the first result of the query, or null if no results.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$user = User::query()->where('email', '=', 'john@example.com')->first();
$admin = User::query()->where('role', '=', 'admin')->first();</code></pre>
                    </div>

                    <h3>CRUD Operations</h3>
                    <h4>Creating Records</h4>
                    <p>Create a new model instance and save it to the database using the <code>save()</code> method.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$user = new User();
$user->name = 'John Doe';
$user->email = 'john@example.com';
$user->password = password_hash('secret', PASSWORD_DEFAULT);
$user->save();</code></pre>
                    </div>

                    <h4>save(): bool</h4>
                    <p>Save the model to the database.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$user = new User();
$user->name = 'Jane Doe';
$user->email = 'jane@example.com';
$user->save();</code></pre>
                    </div>

                    <h4>Updating Records</h4>
                    <p>Update model properties and call <code>save()</code>, or use the query builder to update multiple records.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
// Update single model
$user->name = 'John Smith';
$user->save();

// Update multiple records
User::query()
    ->where('role', '=', 'user')
    ->update(['is_active' => false]);</code></pre>
                    </div>

                    <h4>Deleting Records</h4>
                    <p>Delete a model instance, or use the query builder to delete multiple records.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
// Delete single model
$user->delete();

// Delete multiple records
User::query()
    ->where('last_login', '<', '2023-01-01')
    ->forceDelete();</code></pre>
                    </div>
                </section>

                <section id="query-builder">
                    <h2>QueryBuilder</h2>
                    <p>
                        Provides a fluent interface for building database queries. The QueryBuilder allows you to construct complex SQL queries programmatically with method chaining and parameter binding.
                    </p>

                    <h3>Query Construction</h3>
                    <h4>table(string $table): QueryBuilder</h4>
                    <p>Start a new query on the given table.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$users = QueryBuilder::table('users')->get();
$posts = QueryBuilder::table('posts')->where('published', true)->get();</code></pre>
                    </div>

                    <h3>WHERE Clauses</h3>
                    <h4>where(string $column, mixed $operator = null, mixed $value = null): QueryBuilder</h4>
                    <p>Add a basic where clause to the query.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$users = QueryBuilder::table('users')
    ->where('active', true)
    ->where('age', '>', 18)
    ->where('email', 'like', '%@example.com')
    ->get();</code></pre>
                    </div>

                    <h4>whereIn(string $column, array $values): QueryBuilder</h4>
                    <p>Add a where in clause to the query.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$users = QueryBuilder::table('users')
    ->whereIn('role', ['admin', 'moderator'])
    ->get();</code></pre>
                    </div>

                    <h4>whereBetween(string $column, array $values): QueryBuilder</h4>
                    <p>Add a where between clause to the query.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$users = QueryBuilder::table('users')
    ->whereBetween('created_at', ['2023-01-01', '2023-12-31'])
    ->get();</code></pre>
                    </div>

                    <h4>whereNull(string $column): QueryBuilder</h4>
                    <p>Add a where null clause to the query.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$users = QueryBuilder::table('users')
    ->whereNull('deleted_at')
    ->get();</code></pre>
                    </div>

                    <h3>JOIN Operations</h3>
                    <h4>join(string $table, string $first, string $operator = null, string $second = null): QueryBuilder</h4>
                    <p>Add a join clause to the query.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$users = QueryBuilder::table('users')
    ->join('profiles', 'users.id', '=', 'profiles.user_id')
    ->select('users.*', 'profiles.bio')
    ->get();</code></pre>
                    </div>

                    <h4>leftJoin(string $table, string $first, string $operator = null, string $second = null): QueryBuilder</h4>
                    <p>Add a left join clause to the query.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$users = QueryBuilder::table('users')
    ->leftJoin('orders', 'users.id', '=', 'orders.user_id')
    ->select('users.name', QueryBuilder::raw('COUNT(orders.id) as order_count'))
    ->groupBy('users.id')
    ->get();</code></pre>
                    </div>

                    <h3>Aggregation Methods</h3>
                    <h4>count(string $column = '*'): int</h4>
                    <p>Get the count of records for the query.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$count = QueryBuilder::table('users')->count();
$activeCount = QueryBuilder::table('users')->where('active', true)->count();</code></pre>
                    </div>

                    <h4>max(string $column): mixed</h4>
                    <p>Get the maximum value for the given column.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$maxPrice = QueryBuilder::table('products')->max('price');
$latestLogin = QueryBuilder::table('users')->max('last_login');</code></pre>
                    </div>

                    <h4>sum(string $column): float</h4>
                    <p>Get the sum of values for the given column.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$totalSales = QueryBuilder::table('orders')->sum('amount');
$totalRevenue = QueryBuilder::table('orders')->where('status', 'completed')->sum('amount');</code></pre>
                    </div>
                </section>

                <section id="database-config">
                    <h2>DatabaseConfig</h2>
                    <p>
                        Manages database configuration and connection settings. Provides a centralized way to configure database connections, manage multiple database environments, and handle connection pooling settings.
                    </p>

                    <h3>Configuration Methods</h3>
                    <h4>setConnection(string $name, array $config): void</h4>
                    <p>Set configuration for a named connection.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$config = new DatabaseConfig();
$config->setConnection('mysql', [
    'driver' => 'mysql',
    'host' => 'localhost',
    'database' => 'myapp',
    'username' => 'root',
    'password' => 'password'
]);

$config->setConnection('redis', [
    'driver' => 'redis',
    'host' => 'localhost',
    'port' => 6379
]);</code></pre>
                    </div>

                    <h4>getConnection(string $name = null): array</h4>
                    <p>Get configuration for a connection.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$mysqlConfig = $config->getConnection('mysql');
$defaultConfig = $config->getConnection(); // Gets default connection</code></pre>
                    </div>

                    <h4>setDefaultConnection(string $name): void</h4>
                    <p>Set the default connection name.</p>
                    <div class="code-block">
                        <pre><code>&lt;?php
$config->setDefaultConnection('mysql');</code></pre>
                    </div>
                </section>

                <section id="examples">
                    <h2>Usage Examples</h2>
                    <p>
                        Common patterns and examples for working with the Database & ORM classes.
                    </p>

                    <h3>Basic CRUD Operations</h3>
                    <div class="code-block">
                        <pre><code>&lt;?php
// Create
$user = new User();
$user->name = 'John Doe';
$user->email = 'john@example.com';
$user->save();

// Read
$user = User::query()->id(1)->first();
$users = User::query()->where('is_active', '=', true)->get();

// Update
$user->name = 'Jane Doe';
$user->save();

// Delete
$user->delete();</code></pre>
                    </div>

                    <h3>Complex Queries with Relationships</h3>
                    <div class="code-block">
                        <pre><code>&lt;?php
// Eager load relationships
$users = User::query()->with('posts')->get();

// Access relationship
$user = User::query()->id(1)->first();
$posts = $user->load('posts');

// Query related models
$posts = Post::query()
    ->where('published', '=', true)
    ->get();

// Query with relationship
$user = User::query()->id(1)->first();
$userPosts = $user->relation('posts')->get();</code></pre>
                    </div>

                    <h3>Transaction Management</h3>
                    <div class="code-block">
                        <pre><code>&lt;?php
// Manual transaction handling
$connection = new DatabaseConnection($config);
$connection->beginTransaction();

try {
    $user = new User();
    $user->name = 'John Doe';
    $user->email = 'john@example.com';
    $user->save();
    
    $profile = new Profile();
    $profile->user_id = $user->id;
    $profile->bio = 'Software Developer';
    $profile->save();
    
    $connection->commit();
} catch (Exception $e) {
    $connection->rollBack();
    throw $e;
}

// Using transaction method
$result = $connection->transaction(function() {
    $user = new User();
    $user->name = 'Jane Doe';
    $user->email = 'jane@example.com';
    $user->save();
    
    $profile = new Profile();
    $profile->user_id = $user->id;
    $profile->bio = 'Designer';
    $profile->save();
    
    return $user;
});</code></pre>
                    </div>

                    <h3>Raw SQL Queries</h3>
                    <div class="code-block">
                        <pre><code>&lt;?php
// Complex joins
$results = QueryBuilder::table('users')
    ->join('orders', 'users.id', '=', 'orders.user_id')
    ->join('order_items', 'orders.id', '=', 'order_items.order_id')
    ->select('users.name', QueryBuilder::raw('SUM(order_items.quantity * order_items.price) as total_spent'))
    ->where('orders.status', 'completed')
    ->groupBy('users.id')
    ->having('total_spent', '>', 1000)
    ->orderBy('total_spent', 'desc')
    ->limit(10)
    ->get();

// Raw queries with bindings
$users = $connection->query('
    SELECT u.*, COUNT(p.id) as post_count 
    FROM users u 
    LEFT JOIN posts p ON u.id = p.user_id 
    WHERE u.active = ? 
    GROUP BY u.id 
    HAVING post_count > ?
    ORDER BY post_count DESC
', [true, 5]);</code></pre>
                    </div>
                </section>

                <section id="best-practices">
                    <h2>Some Suggestions</h2>
                    <p>
                        These are just suggestions based on what tends to work well with the Database & ORM layer. You do you. Build however makes sense for your project.
                    </p>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem; margin-top: 1.5rem;">
                        <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem;">
                            <h3 style="font-weight: 600; margin-bottom: 1rem; color: #16a34a;">Things That Often Help</h3>
                            <ul style="list-style: disc; padding-left: 1.5rem; color: #4b5563; font-size: 0.875rem;">
                                <li>Using prepared statements and parameter binding helps prevent SQL injection</li>
                                <li>Leveraging eager loading can avoid N+1 query problems</li>
                                <li>Using transactions for related operations ensures data consistency</li>
                                <li>Indexing frequently queried columns can improve performance</li>
                                <li>Using query builders for complex queries keeps code readable</li>
                                <li>Validating data before database operations catches errors early</li>
                                <li>Using migrations for schema changes makes changes trackable</li>
                                <li>Implementing proper error handling improves reliability</li>
                            </ul>
                        </div>

                        <div style="border: 1px solid #e5e7eb; border-radius: 0.5rem; padding: 1.5rem;">
                            <h3 style="font-weight: 600; margin-bottom: 1rem; color: #ea580c;">Things to Consider</h3>
                            <ul style="list-style: disc; padding-left: 1.5rem; color: #4b5563; font-size: 0.875rem;">
                                <li>Using raw SQL for simple queries can sometimes be more direct</li>
                                <li>Ignoring SQL injection vulnerabilities can create security risks</li>
                                <li>Loading all relationships at once can cause performance issues</li>
                                <li>Ignoring database connection pooling can limit scalability</li>
                                <li>Skipping transaction rollback on errors can leave data inconsistent</li>
                                <li>Ignoring query performance optimization can slow down applications</li>
                                <li>Storing sensitive data in plain text can be a security risk</li>
                                <li>Ignoring database backup strategies can lead to data loss</li>
                            </ul>
                        </div>
                    </div>
                </section>
            </article>
        </main>
    </div>

    <script src="assets/js/docs.js"></script>
</body>
</html>
